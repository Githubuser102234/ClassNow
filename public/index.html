<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClassNow - Home</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="main-content" class="w-full max-w-2xl bg-white rounded-xl shadow-2xl overflow-hidden p-6 mx-4 sm:mx-8 md:mx-auto">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">ClassNow</h1>
        <p class="text-gray-600 text-center mb-8">Sign in, then create or join a class.</p>

        <div id="message-box" class="p-3 my-4 text-sm rounded-lg transition-all duration-300 transform scale-0 h-0"></div>

        <div id="login-forms" class="space-y-6">
            <div id="sign-in-section" class="bg-gray-50 p-6 rounded-lg shadow-inner">
                <h3 class="text-xl font-medium mb-3">Sign In</h3>
                <form id="sign-in-form" class="space-y-4">
                    <input type="email" id="signin-email" placeholder="Email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <input type="password" id="signin-password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-lg font-semibold hover:bg-blue-600 transition-colors">Sign In</button>
                </form>
            </div>

            <div id="sign-up-section" class="bg-gray-50 p-6 rounded-lg shadow-inner">
                <h3 class="text-xl font-medium mb-3">Sign Up</h3>
                <form id="sign-up-form" class="space-y-4">
                    <input type="text" id="signup-name" placeholder="Display Name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <input type="email" id="signup-email" placeholder="Email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <input type="password" id="signup-password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <button type="submit" class="w-full bg-green-500 text-white py-2 rounded-lg font-semibold hover:bg-green-600 transition-colors">Sign Up</button>
                </form>
            </div>
        </div>

        <div id="user-dashboard" class="space-y-6 hidden">
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg shadow-inner mb-6">
                <div class="flex items-center space-x-3">
                    <img id="user-photo" class="w-10 h-10 rounded-full" alt="User Photo">
                    <p id="user-status" class="text-sm text-gray-500 font-medium"></p>
                </div>
                <button id="sign-out-btn" class="text-sm font-semibold text-red-500 hover:text-red-700">Sign Out</button>
            </div>

            <h2 class="text-2xl font-semibold text-center">Join or Create a Class</h2>
            <div class="flex flex-col space-y-4 sm:flex-row sm:space-y-0 sm:space-x-6">
                <div class="bg-gray-50 p-6 rounded-lg shadow-inner flex-1">
                    <h3 class="text-xl font-medium mb-3">Create New Class</h3>
                    <form id="create-class-form" class="space-y-4">
                        <input type="text" id="class-title-input" placeholder="Class Title" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-lg font-semibold hover:bg-blue-600 transition-colors">Create</button>
                    </form>
                </div>
                <div class="bg-gray-50 p-6 rounded-lg shadow-inner flex-1">
                    <h3 class="text-xl font-medium mb-3">Join Existing Class</h3>
                    <form id="join-class-form" class="space-y-4">
                        <input type="text" id="class-id-input" placeholder="Class ID" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-lg font-semibold hover:bg-blue-600 transition-colors">Join</button>
                    </form>
                </div>
            </div>
            <div id="classes-list" class="mt-8 space-y-4">
                </div>
        </div>
    </div>

    <script>
        const messageBox = document.getElementById('message-box');
        const userDashboard = document.getElementById('user-dashboard');
        const loginForms = document.getElementById('login-forms');
        const classesListEl = document.getElementById('classes-list');
        const userStatusEl = document.getElementById('user-status');
        const userPhotoEl = document.getElementById('user-photo');

        function showMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.className = `p-3 my-4 text-sm rounded-lg ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'} transition-all duration-300 transform scale-100`;
            setTimeout(() => {
                messageBox.textContent = '';
                messageBox.className = 'transition-all duration-300 transform scale-0 h-0';
            }, 3000);
        }

        async function updateUI() {
            try {
                const response = await fetch('/api/user');
                if (response.ok) {
                    const { user } = await response.json();
                    userDashboard.classList.remove('hidden');
                    loginForms.classList.add('hidden');
                    userStatusEl.textContent = user.displayName;
                    userPhotoEl.src = user.photoURL;
                    userPhotoEl.classList.remove('hidden');
                    await fetchAndDisplayClasses();
                } else {
                    userDashboard.classList.add('hidden');
                    loginForms.classList.remove('hidden');
                }
            } catch (error) {
                userDashboard.classList.add('hidden');
                loginForms.classList.remove('hidden');
                console.error("Failed to fetch user status:", error);
            }
        }

        async function fetchAndDisplayClasses() {
            try {
                const response = await fetch('/api/classes');
                const { classes } = await response.json();
                classesListEl.innerHTML = '';
                if (classes.length === 0) {
                    classesListEl.innerHTML = '<p class="text-gray-500">No classes found. Create one or join an existing one!</p>';
                    return;
                }
                classes.forEach(cls => {
                    const classCard = document.createElement('div');
                    classCard.className = 'bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-all cursor-pointer';
                    classCard.innerHTML = `
                        <h3 class="text-xl font-semibold text-gray-800">${cls.title}</h3>
                        <p class="text-sm text-gray-500">ID: <span class="font-mono text-gray-700 select-all">${cls.id}</span></p>
                        <p class="mt-2 text-gray-600">Creator: ${cls.creatorName}</p>
                    `;
                    classCard.addEventListener('click', () => {
                        window.location.href = `/classroom/${cls.id}`;
                    });
                    classesListEl.appendChild(classCard);
                });
            } catch (error) {
                console.error("Error fetching classes:", error);
                showMessage("Error loading classes.", true);
            }
        }

        document.getElementById('sign-in-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                if (response.ok) {
                    showMessage('Login successful!');
                    await updateUI();
                } else {
                    const data = await response.json();
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error("Sign-in error:", error);
                showMessage(`Sign-in failed: ${error.message}`, true);
            }
        });

        document.getElementById('sign-up-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const displayName = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            try {
                const response = await fetch('/api/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ displayName, email, password })
                });
                if (response.ok) {
                    showMessage('Account created successfully! Redirecting...');
                    await updateUI();
                } else {
                    const data = await response.json();
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error("Sign-up error:", error);
                showMessage(`Sign-up failed: ${error.message}`, true);
            }
        });

        document.getElementById('sign-out-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/logout', { method: 'POST' });
                if (response.ok) {
                    showMessage('You have been signed out.');
                    updateUI();
                } else {
                    const data = await response.json();
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error("Sign-out error:", error);
                showMessage(`Sign-out failed: ${error.message}`, true);
            }
        });

        document.getElementById('create-class-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('class-title-input').value;
            if (!title) return;

            try {
                const response = await fetch('/api/createClass', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title })
                });
                const data = await response.json();
                if (response.ok) {
                    showMessage('Class created successfully!');
                    e.target.reset();
                    window.location.href = `/classroom/${data.classId}`;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error("Error creating class:", error);
                showMessage(`Failed to create class: ${error.message}`, true);
            }
        });

        document.getElementById('join-class-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const classId = document.getElementById('class-id-input').value;
            if (!classId) return;

            try {
                const response = await fetch('/api/joinClass', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ classId })
                });
                const data = await response.json();
                if (response.ok) {
                    showMessage('Successfully joined class!');
                    e.target.reset();
                    window.location.href = `/classroom/${classId}`;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error("Error joining class:", error);
                showMessage(`Failed to join class: ${error.message}`, true);
            }
        });

        document.addEventListener('DOMContentLoaded', updateUI);
    </script>
</body>
</html>
