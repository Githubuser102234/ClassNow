<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClassNow - Home</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="main-content" class="w-full max-w-2xl bg-white rounded-xl shadow-2xl overflow-hidden p-6 mx-4 sm:mx-8 md:mx-auto">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">ClassNow</h1>
        <p class="text-gray-600 text-center mb-8">Sign in, then create or join a class.</p>

        <!-- Message Box for notifications -->
        <div id="message-box" class="p-3 my-4 text-sm rounded-lg transition-all duration-300 transform scale-0 h-0"></div>

        <div id="login-forms" class="space-y-6">
            <div class="flex flex-col items-center">
                <button id="google-sign-in-btn" class="flex items-center space-x-2 px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M22.022 12.022c0-.671-.059-1.32-.172-1.956H11.954v3.662h5.795c-.255 1.258-1.071 2.38-2.222 3.127v2.408h3.097c1.815-1.68 2.868-4.212 2.868-7.241z" />
                        <path d="M11.954 22.022c3.218 0 5.918-1.066 7.893-2.887l-3.097-2.408c-.858.6-1.96 1.002-3.32 1.002-2.56 0-4.73-1.72-5.507-4.048H3.344v2.484c1.696 3.35 5.253 5.578 8.61 5.578z" />
                        <path d="M6.447 13.917c-.205-.6-.324-1.239-.324-1.917V7.516H3.344c-.672 1.328-1.056 2.836-1.056 4.484s.384 3.156 1.056 4.484l3.103-2.485z" />
                        <path d="M11.954 5.922c1.786 0 3.391.644 4.656 1.706l2.768-2.768C17.873 2.193 15.022.954 11.954.954c-3.357 0-6.914 2.228-8.61 5.578l3.103 2.484C7.224 7.642 9.494 5.922 11.954 5.922z" />
                    </svg>
                    <span>Sign in with Google</span>
                </button>
            </div>
        </div>

        <div id="user-dashboard" class="space-y-6 hidden">
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg shadow-inner mb-6">
                <div class="flex items-center space-x-3">
                    <img id="user-photo" class="w-10 h-10 rounded-full" alt="User Photo">
                    <p id="user-status" class="text-sm text-gray-500 font-medium"></p>
                </div>
                <button id="sign-out-btn" class="text-sm font-semibold text-red-500 hover:text-red-700">Sign Out</button>
            </div>

            <h2 class="text-2xl font-semibold text-center">Join or Create a Class</h2>
            <div class="flex flex-col space-y-4 sm:flex-row sm:space-y-0 sm:space-x-6">
                <!-- Create Class Form -->
                <div class="bg-gray-50 p-6 rounded-lg shadow-inner flex-1">
                    <h3 class="text-xl font-medium mb-3">Create New Class</h3>
                    <form id="create-class-form" class="space-y-4">
                        <input type="text" id="class-title-input" placeholder="Class Title" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-lg font-semibold hover:bg-blue-600 transition-colors">Create</button>
                    </form>
                </div>
                <!-- Join Class Form -->
                <div class="bg-gray-50 p-6 rounded-lg shadow-inner flex-1">
                    <h3 class="text-xl font-medium mb-3">Join Existing Class</h3>
                    <form id="join-class-form" class="space-y-4">
                        <input type="text" id="class-id-input" placeholder="Class ID" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-lg font-semibold hover:bg-blue-600 transition-colors">Join</button>
                    </form>
                </div>
            </div>
            <div id="classes-list" class="mt-8 space-y-4">
                <!-- Classes will be dynamically populated here -->
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

        // Firebase Config from previous chat
        const firebaseConfig = {
            apiKey: "AIzaSyDXuqG3e-LZuSpSG-WRPtuZbDVLyqswBFo",
            authDomain: "classnow-a5164.firebaseapp.com",
            projectId: "classnow-a5164",
            storageBucket: "classnow-a5164.firebasestorage.app",
            messagingSenderId: "490753047342",
            appId: "1:490753047342:web:09afd4c93397fd9e1f98bf"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const messageBox = document.getElementById('message-box');
        const userDashboard = document.getElementById('user-dashboard');
        const loginForms = document.getElementById('login-forms');
        const classesListEl = document.getElementById('classes-list');
        const userStatusEl = document.getElementById('user-status');
        const userPhotoEl = document.getElementById('user-photo');

        function showMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.className = `p-3 my-4 text-sm rounded-lg ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'} transition-all duration-300 transform scale-100`;
            setTimeout(() => {
                messageBox.textContent = '';
                messageBox.className = 'transition-all duration-300 transform scale-0 h-0';
            }, 3000);
        }

        async function signInWithGoogle() {
            try {
                const result = await signInWithPopup(auth, provider);
                const idToken = await result.user.getIdToken();
                // Send ID token to our Vercel API to get a custom token
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ idToken, appId })
                });
                const data = await response.json();
                if (response.ok) {
                    await auth.signInWithCustomToken(data.customToken);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error("Firebase Sign-In Error:", error);
                showMessage(`Sign-in failed: ${error.message}`, true);
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
                showMessage('You have been signed out.');
            } catch (error) {
                console.error("Sign-out error:", error);
                showMessage(`Sign-out failed: ${error.message}`, true);
            }
        }
        
        function displayClasses(classes) {
            classesListEl.innerHTML = '';
            if (classes.length === 0) {
                classesListEl.innerHTML = '<p class="text-gray-500">No classes found. Create one or join an existing one!</p>';
                return;
            }
            classes.forEach(cls => {
                const classCard = document.createElement('div');
                classCard.className = 'bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-all cursor-pointer';
                classCard.innerHTML = `
                    <h3 class="text-xl font-semibold text-gray-800">${cls.title}</h3>
                    <p class="text-sm text-gray-500">ID: <span class="font-mono text-gray-700 select-all">${cls.id}</span></p>
                    <p class="mt-2 text-gray-600">Creator: ${cls.creatorName}</p>
                `;
                classCard.addEventListener('click', () => {
                    window.location.href = `/classroom/${cls.id}`;
                });
                classesListEl.appendChild(classCard);
            });
        }

        function setupClassesListener() {
            const classesRef = collection(db, 'artifacts', appId, 'public', 'data', 'classes');
            onSnapshot(classesRef, (snapshot) => {
                const classes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayClasses(classes);
            }, (error) => {
                console.error("Error listening to classes:", error);
                showMessage("Error loading classes.", true);
            });
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userDashboard.classList.remove('hidden');
                loginForms.classList.add('hidden');
                userStatusEl.textContent = user.displayName;
                userPhotoEl.src = user.photoURL;
                userPhotoEl.classList.remove('hidden');
                setupClassesListener();
            } else {
                userDashboard.classList.add('hidden');
                loginForms.classList.remove('hidden');
                userStatusEl.textContent = 'Not signed in';
                userPhotoEl.classList.add('hidden');
            }
        });

        document.getElementById('google-sign-in-btn').addEventListener('click', signInWithGoogle);
        document.getElementById('sign-out-btn').addEventListener('click', handleSignOut);

        document.getElementById('create-class-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('class-title-input').value;
            if (!title) return;

            try {
                const user = auth.currentUser;
                const token = await user.getIdToken();
                const response = await fetch('/api/createClass', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, userId: user.uid, displayName: user.displayName, photoURL: user.photoURL, appId, token })
                });
                const data = await response.json();
                if (response.ok) {
                    showMessage('Class created successfully!');
                    e.target.reset();
                    window.location.href = `/classroom/${data.classId}`;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error("Error creating class:", error);
                showMessage(`Failed to create class: ${error.message}`, true);
            }
        });

        document.getElementById('join-class-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const classId = document.getElementById('class-id-input').value;
            if (!classId) return;

            try {
                const user = auth.currentUser;
                const token = await user.getIdToken();
                const response = await fetch('/api/joinClass', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ classId, userId: user.uid, displayName: user.displayName, photoURL: user.photoURL, appId, token })
                });
                const data = await response.json();
                if (response.ok) {
                    showMessage('Successfully joined class!');
                    e.target.reset();
                    window.location.href = `/classroom/${classId}`;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error("Error joining class:", error);
                showMessage(`Failed to join class: ${error.message}`, true);
            }
        });

    </script>
</body>
</html>

